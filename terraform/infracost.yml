parameters:
  - name: apiKey
    displayName: Infracost api key
    type: string
    default: 0.10.x
  - name: version
    displayName: Infracost version to install
    type: string
    default: 0.10.x
  - name: currency
    displayName: Currency to show cost in
    type: string
    default: AUD
  - name: githubServiceConnectionName
    displayName: Name of GitHub service connection
    type: string
  - name: workingDirectory
    displayName: Directory where Terraform files are located
    type: string
    default: $(Build.SourcesDirectory)/infrastructure

steps:
  - task: InfracostSetup@1
    displayName: Install Infracost
    inputs:
      apiKey: ${{ parameters.apiKey }}
      version: ${{ parameters.version }}
      currency: ${{ parameters.currency }}
      enableDashboard: true
  - task: PowerShell@2
    displayName: Run Infracost Breakdown
    name: infracost_breakdown
    inputs:
      targetType: inline
      script: |
        infracost breakdown --path plan.json --format json --out-file infracost.json
        $diff = infracost output --path infracost.json --format github-comment
        Write-Host "##vso[task.setvariable variable=DIFF;isOutput=true]$diff"
      errorActionPreference: stop
      showWarnings: true
      pwsh: true
      workingDirectory: ${{ parameters.workingDirectory }}
  - task: GitHubComment@0
    displayName: Comment GitHub Repo
    inputs:
      gitHubConnection: ${{ parameters.githubServiceConnectionName }}
      repositoryName: $(Build.Repository.Name)
      id: $(System.PullRequest.PullRequestNumber)
      comment: $(infracost_breakdown.DIFF)