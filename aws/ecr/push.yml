parameters:
  - name: awsAccountId
    displayName: AWS account ID to push image to
    type: string
    default: $(AWS_ACCOUNT_ID)
  - name: awsRegion
    displayName: AWS region to push image to
    type: string
    default: $(AWS_DEFAULT_REGION)
  - name: imageName
    displayName: Name of the image to push
    type: string
  - name: repositoryName
    displayName: Name of the repository to push image to
    type: string
  - name: tag
    displayName: Tag of the image to push
    type: string
    default: $(Build.BuildNumber)

steps:
  - task: PowerShell@2
    displayName: Push ${{ parameters.imageName }}
    inputs:
      targetType: inline
      script: |
        $EcrUrl="${{ parameters.awsAccountId }}.dkr.ecr.${{ parameters.awsRegion }}.amazonaws.com"
        $EcrImageTag="$EcrUrl/${{ parameters.repositoryName }}:${{ parameters.tag }}"
        docker tag ${{ parameters.imageName }}:${{ parameters.tag }} $EcrImageTag
        aws ecr get-login-password | docker login --password-stdin --username AWS $EcrUrl
        docker push $EcrImageTag
      errorActionPreference: default
      showWarnings: true
      pwsh: true
